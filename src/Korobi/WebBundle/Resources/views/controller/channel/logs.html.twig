{% extends 'KorobiWebBundle::layout.html.twig' %}

{% set page_title = channel_name ~ " on " ~ network_name ~ " - Logs" %}

{% block head %}
<meta name="ROBOTS" content="NOINDEX, NOFOLLOW">
{% endblock %}

{% block javascripts %}
{{ parent() }}
{% if is_tail %}
<script>
function pad(n) {
    n = n + '';
    return n.length >= 2 ? n : new Array(2 - n.length + 1).join('0') + n;
}
var last_id = '{{ last_id }}';
$(document).scrollTop($("#bottom").offset().top);
setInterval(function() {
    $.ajax({
        url: '{{ url(app.request.attributes.get('_route'), app.request.attributes.get('_route_params')) }}',
        data: { last_id: last_id },
        type: 'GET',
        success: function(data) {
            var json = JSON.parse(data);
            if(json.length == 0) {
                return;
            }

            var logs = $('.logs');
            $.each(json, function(index, line) {
                var timestamp = $('<span/>')
                    .addClass('timestamp')
                    .html(line.timestamp);
                var nick = $('<span/>')
                    .addClass('nick irc--' + pad(line.nickColour) + '-df ' + line.role)
                    .html(line.nick);
                var message = $('<span/>')
                    .addClass('message')
                    .html(line.message);
                logs.append(
                    $('<div/>')
                        .attr({
                            'data-event-id': line.id,
                            'data-event-type': line.type
                        })
                        .addClass('line')
                        .append(timestamp)
                        .append(nick)
                        .append(message)
                );
            });
            last_id = json.slice(-1)[0].id;
            $(document).scrollTop($("#bottom").offset().top);
        }
    });
}, 5000);
</script>
{% endif %}
{% endblock %}

{% block body %}
    <h1>Log for {{ channel_name }} on {{ network_name }} - {{ log_date }}</h1>
    <div class="logs{% if is_tail %} tailing{% endif %}">
        {% for line_num, line in logs %}
            <div data-nick="{{ line.nick }}" data-event-id="{{ line.id }}" data-event-type="{{ line.type }}" class="line{% if not is_tail %} js-hl" data-line-num="{{ line_num + 1 }}{% endif %}">
                <span class="timestamp">
                    {{ line.timestamp }}
                </span>
                <span class="nick irc--{{ "%02d"|format(line.nickColour) }}-df {% if line.role is not empty %}{{ line.role }}{% endif %}">
                    {{- line.nick -}}
                </span>
                <span class="message">
                    {{- line.message -}}
                </span>
            </div>
        {% endfor %}
    </div>
{% endblock %}
